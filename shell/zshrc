# =============================================================================
# ~/.zshrc - Main Zsh Configuration
# =============================================================================
# Managed by dotfiles: https://github.com/mikeyfarina/dotfiles
# =============================================================================

# Disable p10k configuration wizard (we have our config)
typeset -g POWERLEVEL9K_DISABLE_CONFIGURATION_WIZARD=true

# Enable Powerlevel10k instant prompt (must be near top)
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
    source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# -----------------------------------------------------------------------------
# Dotfiles location (Codespaces uses a different path)
# -----------------------------------------------------------------------------
if [[ -n "$CODESPACES" && -d "/workspaces/.codespaces/.persistedshare/dotfiles" ]]; then
    export DOTFILES="/workspaces/.codespaces/.persistedshare/dotfiles"
else
    export DOTFILES="$HOME/dotfiles"
fi

# -----------------------------------------------------------------------------
# Load modular configurations
# -----------------------------------------------------------------------------
for config in path exports options; do
    [[ -f "$DOTFILES/shell/${config}.zsh" ]] && source "$DOTFILES/shell/${config}.zsh"
done

# -----------------------------------------------------------------------------
# Zle widgets (must be loaded before plugins that reference them)
# -----------------------------------------------------------------------------
autoload -U up-line-or-beginning-search
autoload -U down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search

# -----------------------------------------------------------------------------
# Oh My Zsh
# -----------------------------------------------------------------------------
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"

# Plugins (platform-aware)
plugins=(git zsh-autosuggestions zsh-completions zsh-history-substring-search fzf)

# Add platform-specific plugins
case "$(uname -s)" in
    Darwin)
        plugins+=(macos docker npm)
        ;;
    Linux)
        plugins+=(docker npm)
        ;;
esac

# syntax-highlighting must be last in the plugins list
plugins+=(zsh-syntax-highlighting)

# zsh-completions needs its src dir in fpath before compinit
fpath+=${ZSH_CUSTOM:-${ZSH:-~/.oh-my-zsh}/custom}/plugins/zsh-completions/src

source "$ZSH/oh-my-zsh.sh"

# -----------------------------------------------------------------------------
# Load remaining configurations (after oh-my-zsh)
# -----------------------------------------------------------------------------
for config in aliases functions nvm tools; do
    [[ -f "$DOTFILES/shell/${config}.zsh" ]] && source "$DOTFILES/shell/${config}.zsh"
done

# -----------------------------------------------------------------------------
# Powerlevel10k
# -----------------------------------------------------------------------------
[[ -f "$DOTFILES/tools/p10k.zsh" ]] && source "$DOTFILES/tools/p10k.zsh"

# -----------------------------------------------------------------------------
# Local overrides (not tracked in git)
# -----------------------------------------------------------------------------
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"
